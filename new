import pandas as pd
import matplotlib.pyplot as plt

# Step 1: Generate Start_Week and Done_Week from your date columns
df['Start_Week'] = pd.to_datetime(df['First_In_Progress']).dt.isocalendar().week
df['Done_Week'] = pd.to_datetime(df['Done']).dt.isocalendar().week

# Step 2: Filter for tasks that were started and completed in the same week
same_week = df[
    df['First_In_Progress'].notna() &
    df['Done'].notna() &
    (df['Start_Week'] == df['Done_Week'])
]

# Step 3: Group by Done_Week and sum story points
weekly_same = same_week.groupby('Done_Week')['Story Points'].sum().reset_index()
weekly_same.rename(columns={'Done_Week': 'Week', 'Story Points': 'Finished_Same_Week'}, inplace=True)

# Step 4: Ensure all weeks show up (fill in missing with 0s)
all_weeks = pd.DataFrame({'Week': sorted(df['Done_Week'].dropna().unique())})
weekly_same = all_weeks.merge(weekly_same, on='Week', how='left')
weekly_same['Finished_Same_Week'] = weekly_same['Finished_Same_Week'].fillna(0).astype(int)

# Step 5: Plot the weekly story point completion trend
plt.figure(figsize=(10, 5))
plt.plot(weekly_same['Week'], weekly_same['Finished_Same_Week'],
         marker='o', linestyle='-', color='darkgreen', label='Finished in Same Week')

# Add data labels
for x, y in zip(weekly_same['Week'], weekly_same['Finished_Same_Week']):
    plt.text(x, y + 0.5, f'{y}', ha='center', fontsize=9)

plt.title('Weekly Story Points Started and Completed in Same Week')
plt.xlabel('Week')
plt.ylabel('Story Points')
plt.grid(True, linestyle='--', alpha=0.6)
plt.legend()
plt.tight_layout()
plt.show()


