
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

# 1. AUTO-DETECT TRANSITION COLUMNS
def extract_transitions(df):
    """Find all [Stage1]_to_[Stage2] columns automatically"""
    transitions = [col for col in df.columns if '_to_' in col]
    
    # Get unique stages from column names
    all_stages = set()
    for col in transitions:
        from_stage, to_stage = col.split('_to_')
        all_stages.update([from_stage, to_stage])
    all_stages = sorted(all_stages)
    
    # Build transition matrix
    transition_matrix = pd.DataFrame(index=all_stages, columns=all_stages)
    for col in transitions:
        from_stage, to_stage = col.split('_to_')
        transition_matrix.loc[from_stage, to_stage] = df[col].median()
    
    return transition_matrix

# 2. GENERATE HEATMAP
transition_data = extract_transitions(df)

plt.figure(figsize=(10, 8))
sns.heatmap(
    transition_data.astype(float),
    annot=True,
    fmt=".1f",
    cmap="YlOrRd",
    linewidths=0.5,
    linecolor='white',
    mask=transition_data.isna()  # Hide empty cells
)

plt.title("Workflow Transition Times (Auto-Extracted)", pad=20)
plt.xlabel("To Stage →", labelpad=10)
plt.ylabel("← From Stage", labelpad=10)
plt.xticks(rotation=45, ha='right')
plt.yticks(rotation=0)
plt.tight_layout()
plt.show()
