

import pandas as pd
import matplotlib.pyplot as plt

# Step 1: Generate Start_Week and Done_Week
df['Start_Week'] = pd.to_datetime(df['First_In_Progress']).dt.isocalendar().week
df['Done_Week'] = pd.to_datetime(df['Done']).dt.isocalendar().week

# Step 2: Filter to tasks started ONLY in PI 25.1 (Jan–Mar 2025)
pi_start = pd.to_datetime('2025-01-01')
pi_end = pd.to_datetime('2025-03-31')

pi_tasks = df[
    df['First_In_Progress'].notna() &
    (df['First_In_Progress'] >= pi_start) &
    (df['First_In_Progress'] <= pi_end)
]

# Step 3: Only keep those that were completed
pi_completed = pi_tasks[pi_tasks['Done'].notna()]

# Step 4: Group by Done_Week (completions per week, only for PI-started tasks)
weekly_progression = pi_completed.groupby('Done_Week')['Story Points'].sum().reset_index()
weekly_progression.rename(columns={'Done_Week': 'Week', 'Story Points': 'Completed'}, inplace=True)

# Step 5: Fill all weeks to ensure continuity
all_weeks = pd.DataFrame({'Week': range(weekly_progression['Week'].min(), weekly_progression['Week'].max() + 1)})
weekly_progression = all_weeks.merge(weekly_progression, on='Week', how='left')
weekly_progression['Completed'] = weekly_progression['Completed'].fillna(0).astype(int)

# Step 6: Plot
plt.figure(figsize=(10, 5))
plt.plot(weekly_progression['Week'], weekly_progression['Completed'],
         marker='o', linestyle='-', color='navy', label='Completed (Started in PI Only)')

# Add average trendline
avg_completed = weekly_progression['Completed'].mean()
plt.axhline(avg_completed, color='darkgreen', linestyle='--', label=f'Avg: {avg_completed:.1f} Story Points')

# Add data labels
for x, y in zip(weekly_progression['Week'], weekly_progression['Completed']):
    if y > 0:
        plt.text(x, y + 0.5, f'{y}', ha='center', fontsize=9)

# Final styling
plt.title('PI 25.1 Weekly Story Point Completion — Started in PI Only')
plt.xlabel('Week')
plt.ylabel('Story Points')
plt.grid(True, linestyle='--', alpha=0.6)
plt.xticks(weekly_progression['Week'])  # Show every week
plt.legend()
plt.tight_layout()
plt.show()
