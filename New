# Monthly Story Point Completion Ratio (Corrected)
monthly_focus = []

for label, (start_date, end_date) in month_windows.items():
    # Story points started in the month
    started = df[
        df['First_In_Progress'].notna() &
        (df['First_In_Progress'] >= start_date) &
        (df['First_In_Progress'] <= end_date)
    ]['Story Points'].sum()

    # Story points completed in the month
    completed = df[
        df['Done'].notna() &
        (df['Done'] >= start_date) &
        (df['Done'] <= end_date)
    ]['Story Points'].sum()

    monthly_focus.append({'Month': label, 'Started': started, 'Completed': completed})

focus_df = pd.DataFrame(monthly_focus).set_index('Month')

# Plotting
ax_focus = focus_df[['Completed', 'Started']].plot(
    kind='bar', stacked=False, color=['navy', 'silver'], figsize=(8, 5)
)

for container in ax_focus.containers:
    ax_focus.bar_label(container, fmt='%.0f', label_type='center', fontsize=9, color='white')

# Add % completion labels above bars
for idx, row in enumerate(focus_df.itertuples()):
    if row.Started > 0:
        pct = row.Completed / row.Started * 100
        ax_focus.text(idx, row.Completed + 1, f"{pct:.0f}%", ha='right', fontsize=9, color='navy')

# Average completion line
avg_completed = focus_df['Completed'].mean()
ax_focus.axhline(avg_completed, color='darkgreen', linestyle='--', 
                 label=f'Avg Completed Story Points: {avg_completed:.1f}')

plt.title('PI 25.1 Story Point Completion Ratio')
plt.ylabel('Story Points')
plt.xticks(rotation=0)
plt.legend()
plt.tight_layout()
plt.show()
