monthly_focus = []

for label, (start_date, end_date) in month_windows.items():
    # Tasks started in this month
    started = df[
        df['First_In_Progress'].notna() &
        (df['First_In_Progress'] >= start_date) &
        (df['First_In_Progress'] <= end_date)
    ]

    # Of those, how many were also completed in the same month
    completed_same_month = started[
        started['Done'].notna() &
        (started['Done'] >= start_date) &
        (started['Done'] <= end_date)
    ]

    started_count = len(started)
    completed_count = len(completed_same_month)
    rate = (completed_count / started_count * 100) if started_count > 0 else 0

    monthly_focus.append({
        'Month': label,
        'Started': started_count,
        'Completed': completed_count,
        'Completion %': round(rate, 1)
    })

# Convert to DataFrame
plot_df = pd.DataFrame(monthly_focus)
plot_df['Month'] = pd.Categorical(plot_df['Month'], categories=month_order, ordered=True)

# Plot
plt.figure(figsize=(8, 5))
bar_width = 0.4
x = range(len(plot_df))

plt.bar([i - bar_width/2 for i in x], plot_df['Started'], width=bar_width, color='silver', label='Started')
plt.bar([i + bar_width/2 for i in x], plot_df['Completed'], width=bar_width, color='navy', label='Completed')

# % labels above Completed bars
for i, row in plot_df.iterrows():
    plt.text(i + bar_width/2, row['Completed'] + 0.3, f"{row['Completion %']}%", 
             ha='center', fontsize=9, color='navy')

# Format
plt.xticks(x, plot_df['Month'])
plt.ylabel('Number of Tasks')
plt.title('PI 25.1 Task Completion Rate (Started vs Completed Same Month)')
plt.legend()
plt.grid(axis='y', linestyle='--', alpha=0.5)
plt.tight_layout()
plt.show()
